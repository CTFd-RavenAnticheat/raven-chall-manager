---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ingress-patcher
  namespace: networking
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: ingress-patcher
rules:
- apiGroups: ["networking.k8s.io"]
  resources: ["ingresses"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["networking.k8s.io"]
  resources: ["ingresses/status"]
  verbs: ["get", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: ingress-patcher
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: ingress-patcher
subjects:
- kind: ServiceAccount
  name: ingress-patcher
  namespace: networking
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ingress-patcher
  namespace: networking
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ingress-patcher
  template:
    metadata:
      labels:
        app: ingress-patcher
    spec:
      serviceAccountName: ingress-patcher
      containers:
      - name: patcher
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          HOST_IP="${HOST_IP:-127.0.0.1}"
          echo "Starting Ingress patcher with IP: $HOST_IP"
          while true; do
            kubectl get ingress --all-namespaces -o json | jq -r '.items[] | select(.status.loadBalancer.ingress == null or (.status.loadBalancer.ingress | length) == 0) | "\(.metadata.namespace) \(.metadata.name)"' | while read ns name; do
              if [ -n "$ns" ] && [ -n "$name" ]; then
                echo "Patching ingress $ns/$name with IP $HOST_IP"
                kubectl patch ingress "$name" -n "$ns" --type=merge --subresource=status -p "{\"status\":{\"loadBalancer\":{\"ingress\":[{\"ip\":\"$HOST_IP\"}]}}}" || true
              fi
            done
            sleep 2
          done
        env:
        - name: HOST_IP
          value: "192.168.100.9"
