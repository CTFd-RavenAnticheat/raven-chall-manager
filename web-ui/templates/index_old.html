<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chall-Manager Scenario Builder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .scenario-type-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .type-btn {
            padding: 15px 30px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .type-btn:hover {
            background: white;
            color: #667eea;
        }

        .type-btn.active {
            background: white;
            color: #667eea;
            transform: scale(1.05);
        }

        .card-body {
            padding: 40px;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h3 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Courier New', monospace;
        }

        .checkbox-group {
            flex-direction: row;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* Dynamic sections */
        .scenario-specific {
            display: none;
        }

        .scenario-specific.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Container cards */
        .container-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            position: relative;
        }

        .container-card h4 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .remove-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ff4757;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        .remove-btn:hover {
            background: #ee3742;
        }

        .add-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .add-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .port-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: end;
            margin-bottom: 10px;
        }

        .port-row input,
        .port-row select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
        }

        .remove-port-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
        }

        /* Submit button */
        .submit-section {
            text-align: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #eee;
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 60px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Result card */
        .result-card {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-top: 30px;
            display: none;
        }

        .result-card.show {
            display: block;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-card h3 {
            margin-bottom: 15px;
            font-size: 24px;
        }

        .result-card .scenario-ref {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            margin: 15px 0;
        }

        .copy-btn {
            background: white;
            color: #11998e;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }

        .copy-btn:hover {
            background: #f0f0f0;
        }

        .cli-command {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin-top: 15px;
            overflow-x: auto;
        }

        /* Error card */
        .error-card {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            display: none;
        }

        .error-card.show {
            display: block;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Loading spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* YAML editor */
        .yaml-editor {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            width: 100%;
            min-height: 300px;
            font-size: 14px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üö© Chall-Manager Scenario Builder</h1>
            <p>Create and deploy CTF challenge scenarios with ease</p>
        </header>

        <div class="main-card">
            <div class="card-header">
                <h2>Choose Scenario Type</h2>
                <div class="scenario-type-selector">
                    <button class="type-btn active" data-type="monopod">
                        üì¶ Monopod<br>
                        <small>Single Container</small>
                    </button>
                    <button class="type-btn" data-type="multipod">
                        üì¶üì¶ Multipod<br>
                        <small>Multi-Container</small>
                    </button>
                    <button class="type-btn" data-type="kompose">
                        üê≥ Docker Compose<br>
                        <small>Import YAML</small>
                    </button>
                </div>
            </div>

            <div class="card-body">
                <form id="scenario-form">
                    <!-- Common Configuration -->
                    <div class="form-section">
                        <h3>‚öôÔ∏è Basic Configuration</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="identity">Challenge Identity *</label>
                                <input type="text" id="identity" name="identity" required 
                                       placeholder="e.g., web-challenge-1">
                            </div>
                            <div class="form-group">
                                <label for="challenge_id">Challenge ID (optional)</label>
                                <input type="text" id="challenge_id" name="challenge_id"
                                       placeholder="Defaults to identity">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="hostname">Hostname</label>
                                <input type="text" id="hostname" name="hostname"
                                       placeholder="e.g., ctf.example.com">
                            </div>
                            <div class="form-group">
                                <label for="label">Label</label>
                                <input type="text" id="label" name="label"
                                       placeholder="e.g., web, crypto, pwn">
                            </div>
                        </div>
                    </div>

                    <!-- Monopod Section -->
                    <div id="monopod-section" class="scenario-specific active">
                        <div class="form-section">
                            <h3>üì¶ Container Configuration</h3>
                            <div id="monopod-containers">
                                <div class="container-card" data-container-idx="0">
                                    <h4>Container</h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Name *</label>
                                            <input type="text" class="container-name" required value="main">
                                        </div>
                                        <div class="form-group">
                                            <label>Image *</label>
                                            <input type="text" class="container-image" required 
                                                   placeholder="nginx:latest">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Ports</label>
                                        <div class="ports-list">
                                            <div class="port-row">
                                                <input type="number" class="port-number" placeholder="Port" 
                                                       min="1" max="65535" value="80">
                                                <select class="port-protocol">
                                                    <option value="TCP">TCP</option>
                                                    <option value="UDP">UDP</option>
                                                </select>
                                                <select class="port-expose">
                                                    <option value="internal">Internal</option>
                                                    <option value="NodePort">NodePort</option>
                                                    <option value="LoadBalancer">LoadBalancer</option>
                                                    <option value="ingress">Ingress</option>
                                                </select>
                                                <button type="button" class="remove-port-btn" onclick="removePort(this)">‚úï</button>
                                            </div>
                                        </div>
                                        <button type="button" class="add-btn" onclick="addPort(this)">+ Add Port</button>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Environment Variables</label>
                                            <textarea class="container-envs" rows="3" 
                                                      placeholder="KEY=value&#10;FLAG=CTF{...}"></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>Resource Limits</label>
                                            <input type="text" class="container-cpu" placeholder="CPU (e.g., 500m)">
                                            <input type="text" class="container-memory" placeholder="Memory (e.g., 512Mi)" 
                                                   style="margin-top: 10px;">
                                        </div>
                                    </div>
                                    <div class="form-group checkbox-group">
                                        <input type="checkbox" class="container-pcap" id="pcap-0">
                                        <label for="pcap-0">Enable Packet Capture</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Multipod Section -->
                    <div id="multipod-section" class="scenario-specific">
                        <div class="form-section">
                            <h3>üì¶üì¶ Containers</h3>
                            <div id="multipod-containers">
                                <!-- Containers will be added dynamically -->
                            </div>
                            <button type="button" class="add-btn" onclick="addMultipodContainer()">
                                + Add Container
                            </button>
                        </div>

                        <div class="form-section">
                            <h3>üîó Network Rules</h3>
                            <div id="multipod-rules">
                                <!-- Rules will be added dynamically -->
                            </div>
                            <button type="button" class="add-btn" onclick="addRule()">
                                + Add Rule
                            </button>
                        </div>
                    </div>

                    <!-- Kompose Section -->
                    <div id="kompose-section" class="scenario-specific">
                        <div class="form-section">
                            <h3>üê≥ Docker Compose YAML</h3>
                            <div class="form-group">
                                <label>Docker Compose Configuration *</label>
                                <textarea id="compose-yaml" class="yaml-editor" rows="20" 
                                          placeholder="version: '3.8'
services:
  web:
    image: nginx:latest
    ports:
      - '80:80'"></textarea>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>‚öôÔ∏è Service Configuration</h3>
                            <div id="kompose-services">
                                <!-- Service configs will be added dynamically -->
                            </div>
                        </div>
                    </div>

                    <!-- Scenario Configuration -->
                    <div class="form-section">
                        <h3>üîê Scenario Registry</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="registry_url">Registry URL</label>
                                <input type="text" id="registry_url" name="registry_url" 
                                       placeholder="registry.io" required>
                            </div>
                            <div class="form-group">
                                <label for="tag">Version Tag</label>
                                <input type="text" id="tag" name="tag" value="latest">
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Configuration -->
                    <div class="form-section">
                        <h3>üîß Advanced Options</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="image_pull_secrets">Image Pull Secrets (one per line)</label>
                                <textarea id="image_pull_secrets" name="image_pull_secrets" rows="3"
                                          placeholder="gitlab-registry&#10;dockerhub-secret"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="packet_capture_pvc">Packet Capture PVC</label>
                                <input type="text" id="packet_capture_pvc" name="packet_capture_pvc"
                                       placeholder="pcap-core">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="additional_config">Additional Configuration (KEY=value per line)</label>
                            <textarea id="additional_config" name="additional_config" rows="3"
                                      placeholder="challenge_type=web&#10;difficulty=medium"></textarea>
                        </div>
                    </div>

                    <!-- Submit Options -->
                    <div class="submit-section">
                        <div class="push-option" style="margin-bottom: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="push-to-registry" style="margin-right: 10px;" checked>
                                <span>Push to OCI Registry (requires registry credentials above)</span>
                            </label>
                        </div>
                        <div class="loading" id="loading">
                            <div class="spinner"></div>
                            <p id="loading-text">Building and pushing scenario...</p>
                        </div>
                        <button type="submit" class="submit-btn" id="submit-btn">
                            üöÄ Create & Push Scenario
                        </button>
                    </div>
                </form>

                <!-- Error Card -->
                <div class="error-card" id="error-card">
                    <strong>Error:</strong> <span id="error-message"></span>
                </div>

                <!-- Result Card -->
                <div class="result-card" id="result-card">
                    <h3>‚úÖ Scenario Created Successfully!</h3>
                    <p id="result-message">Your scenario has been built and pushed to the registry:</p>
                    <div class="scenario-ref" id="scenario-ref"></div>
                    <button class="copy-btn" onclick="copyScenarioRef()">üìã Copy Reference</button>
                    
                    <h4 style="margin-top: 25px;" id="cli-heading">Use with chall-manager:</h4>
                    <div class="cli-command" id="cli-command"></div>
                    <button class="copy-btn" onclick="copyCliCommand()">üìã Copy Command</button>
                    <button class="download-btn" id="download-btn" style="background: #38ef7d; color: white; margin-top: 15px; display: none;">
                        üì• Download ZIP
                                            </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentScenarioType = 'monopod';
        let multipodContainerCount = 0;
        let ruleCount = 0;

        // Scenario type selector
        document.querySelectorAll('.type-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                currentScenarioType = btn.dataset.type;
                
                // Show/hide scenario-specific sections
                document.querySelectorAll('.scenario-specific').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(currentScenarioType + '-section').classList.add('active');
            });
        });

        // Update button text based on push-to-registry checkbox
        const pushCheckbox = document.getElementById('push-to-registry');
        const submitBtn = document.getElementById('submit-btn');
        const loadingText = document.getElementById('loading-text');
        
        function updateSubmitButton() {
            if (pushCheckbox.checked) {
                submitBtn.textContent = 'üöÄ Create & Push Scenario';
                loadingText.textContent = 'Building and pushing scenario...';
            } else {
                submitBtn.textContent = 'üì¶ Create & Download ZIP';
                loadingText.textContent = 'Building scenario...';
            }
        }
        
        pushCheckbox.addEventListener('change', updateSubmitButton);
        updateSubmitButton();  // Set initial state

        // Add port to container
        function addPort(btn) {
            const portsList = btn.previousElementSibling;
            const newPort = document.createElement('div');
            newPort.className = 'port-row';
            newPort.innerHTML = `
                <input type="number" class="port-number" placeholder="Port" min="1" max="65535">
                <select class="port-protocol">
                    <option value="TCP">TCP</option>
                    <option value="UDP">UDP</option>
                </select>
                <select class="port-expose">
                    <option value="internal">Internal</option>
                    <option value="NodePort">NodePort</option>
                    <option value="LoadBalancer">LoadBalancer</option>
                    <option value="ingress">Ingress</option>
                </select>
                <button type="button" class="remove-port-btn" onclick="removePort(this)">‚úï</button>
            `;
            portsList.appendChild(newPort);
        }

        // Remove port
        function removePort(btn) {
            btn.parentElement.remove();
        }

        // Add Multipod container
        function addMultipodContainer() {
            multipodContainerCount++;
            const container = document.createElement('div');
            container.className = 'container-card';
            container.dataset.containerIdx = multipodContainerCount;
            container.innerHTML = `
                <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Remove</button>
                <h4>Container ${multipodContainerCount}</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" class="container-name" required placeholder="e.g., web">
                    </div>
                    <div class="form-group">
                        <label>Image *</label>
                        <input type="text" class="container-image" required placeholder="nginx:latest">
                    </div>
                </div>
                <div class="form-group">
                    <label>Ports</label>
                    <div class="ports-list">
                        <div class="port-row">
                            <input type="number" class="port-number" placeholder="Port" min="1" max="65535" value="80">
                            <select class="port-protocol">
                                <option value="TCP">TCP</option>
                                <option value="UDP">UDP</option>
                            </select>
                            <select class="port-expose">
                                <option value="internal">Internal</option>
                                <option value="NodePort">NodePort</option>
                                <option value="LoadBalancer">LoadBalancer</option>
                                <option value="ingress">Ingress</option>
                            </select>
                            <button type="button" class="remove-port-btn" onclick="removePort(this)">‚úï</button>
                        </div>
                    </div>
                    <button type="button" class="add-btn" onclick="addPort(this)">+ Add Port</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Environment Variables</label>
                        <textarea class="container-envs" rows="3" placeholder="KEY=value&#10;FLAG=CTF{...}"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Resource Limits</label>
                        <input type="text" class="container-cpu" placeholder="CPU (e.g., 500m)">
                        <input type="text" class="container-memory" placeholder="Memory (e.g., 512Mi)" style="margin-top: 10px;">
                    </div>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" class="container-pcap" id="pcap-${multipodContainerCount}">
                    <label for="pcap-${multipodContainerCount}">Enable Packet Capture</label>
                </div>
            `;
            document.getElementById('multipod-containers').appendChild(container);
        }

        // Add network rule
        function addRule() {
            ruleCount++;
            const rule = document.createElement('div');
            rule.className = 'container-card';
            rule.style.background = '#fff3cd';
            rule.innerHTML = `
                <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Remove</button>
                <h4>Rule ${ruleCount}</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>From Container</label>
                        <input type="text" class="rule-from" required placeholder="container name">
                    </div>
                    <div class="form-group">
                        <label>To Container</label>
                        <input type="text" class="rule-to" required placeholder="container name">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ports (comma-separated)</label>
                        <input type="text" class="rule-ports" required placeholder="8080, 5432">
                    </div>
                    <div class="form-group">
                        <label>Protocol</label>
                        <select class="rule-protocol">
                            <option value="TCP">TCP</option>
                            <option value="UDP">UDP</option>
                        </select>
                    </div>
                </div>
            `;
            document.getElementById('multipod-rules').appendChild(rule);
        }

        // Form submission
        document.getElementById('scenario-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            const loading = document.getElementById('loading');
            const errorCard = document.getElementById('error-card');
            const resultCard = document.getElementById('result-card');
            
            submitBtn.disabled = true;
            loading.classList.add('show');
            errorCard.classList.remove('show');
            resultCard.classList.remove('show');
            
            try {
                const formData = collectFormData();
                const pushToRegistry = document.getElementById('push-to-registry')?.checked || false;
                
                if (pushToRegistry) {
                    // Push to registry
                    await pushScenarioToRegistry(formData);
                } else {
                    // Download ZIP
                    await downloadScenarioZip(formData);
                }
            } catch (error) {
                document.getElementById('error-message').textContent = error.message;
                errorCard.classList.add('show');
            } finally {
                submitBtn.disabled = false;
                loading.classList.remove('show');
            }
        });
        
        // Push scenario to registry
        async function pushScenarioToRegistry(formData) {
            const response = await fetch('/api/build-and-push-scenario', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData),
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                document.getElementById('result-message').textContent = 'Your scenario has been built and pushed to the registry:';
                document.getElementById('scenario-ref').textContent = result.scenario_ref;
                document.getElementById('cli-heading').textContent = 'Use with chall-manager:';
                document.getElementById('cli-command').textContent = 
                    `chall-manager-cli challenge create \\\n    --id ${formData.identity} \\\n    --scenario ${result.scenario_ref} \\\n    --image-pull-secrets ${formData.image_pull_secrets || ''}`;
                document.getElementById('result-card').classList.add('show');
            } else {
                throw new Error(result.error || 'Failed to push scenario');
            }
        }
        
        // Download scenario ZIP
        async function downloadScenarioZip(formData) {
            const response = await fetch('/api/create-scenario', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData),
            });
            
            if (response.ok) {
                // Download the ZIP file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${formData.identity}-scenario.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                // Show success message
                document.getElementById('result-message').textContent = 'Your scenario has been built and downloaded:';
                document.getElementById('scenario-ref').textContent = `${formData.identity}-scenario.zip`;
                document.getElementById('cli-heading').textContent = 'Deploy locally:';
                document.getElementById('cli-command').textContent = 
                    `# Extract and deploy locally:\nunzip ${formData.identity}-scenario.zip\ncd ${formData.identity}\npulumi up`;
                document.getElementById('result-card').classList.add('show');
            } else {
                const result = await response.json();
                throw new Error(result.error || 'Failed to create scenario');
            }
        }

        // Collect form data based on scenario type
        function collectFormData() {
            const data = {
                scenario_type: currentScenarioType,
                identity: document.getElementById('identity').value,
                challenge_id: document.getElementById('challenge_id').value,
                hostname: document.getElementById('hostname').value,
                label: document.getElementById('label').value,
                tag: document.getElementById('tag').value,
                registry_url: document.getElementById('registry_url').value,
                image_pull_secrets: document.getElementById('image_pull_secrets').value,
                packet_capture_pvc: document.getElementById('packet_capture_pvc').value,
                additional_config: document.getElementById('additional_config').value,
            };

            if (currentScenarioType === 'monopod') {
                data.container = collectContainerData(
                    document.querySelector('#monopod-containers .container-card')
                );
            } else if (currentScenarioType === 'multipod') {
                data.containers = [];
                document.querySelectorAll('#multipod-containers .container-card').forEach(card => {
                    data.containers.push(collectContainerData(card));
                });
                
                data.rules = [];
                document.querySelectorAll('#multipod-rules .container-card').forEach(card => {
                    data.rules.push({
                        from_container: card.querySelector('.rule-from').value,
                        to_container: card.querySelector('.rule-to').value,
                        ports: card.querySelector('.rule-ports').value,
                        protocol: card.querySelector('.rule-protocol').value,
                    });
                });
            } else if (currentScenarioType === 'kompose') {
                data.compose_yaml = document.getElementById('compose-yaml').value;
            }

            return data;
        }

        // Collect container data from card
        function collectContainerData(card) {
            const ports = [];
            card.querySelectorAll('.port-row').forEach(row => {
                ports.push({
                    port: parseInt(row.querySelector('.port-number').value),
                    protocol: row.querySelector('.port-protocol').value,
                    expose_type: row.querySelector('.port-expose').value,
                });
            });

            return {
                name: card.querySelector('.container-name').value,
                image: card.querySelector('.container-image').value,
                ports: ports,
                envs: card.querySelector('.container-envs').value,
                limit_cpu: card.querySelector('.container-cpu').value,
                limit_memory: card.querySelector('.container-memory').value,
                packet_capture: card.querySelector('.container-pcap').checked,
            };
        }

        // Copy scenario reference
        function copyScenarioRef() {
            const ref = document.getElementById('scenario-ref').textContent;
            navigator.clipboard.writeText(ref).then(() => {
                alert('Copied to clipboard!');
            });
        }

        // Copy CLI command
        function copyCliCommand() {
            const cmd = document.getElementById('cli-command').textContent;
            navigator.clipboard.writeText(cmd).then(() => {
                alert('Copied to clipboard!');
            });
        }
    </script>
</body>
</html>
